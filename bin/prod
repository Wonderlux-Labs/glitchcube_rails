#!/usr/bin/env ruby

require "fileutils"

# Run Rails with SolidQueue in production
APP_ROOT = File.expand_path("..", __dir__)
Dir.chdir(APP_ROOT) do
  puts "ðŸš€ Starting Rails server and SolidQueue worker in production mode..."
  
  # Set production environment
  ENV["RAILS_ENV"] = "production"
  
  pids = []
  
  # Start Rails server on port 4567 in production mode, daemonized
  pids << spawn(
    { "RAILS_ENV" => "production" },
    "bin/rails", "server", 
    "-e", "production",
    "-p", "4567", 
    "-b", "0.0.0.0",
    "-d",  # Daemonize in production
    *ARGV
  )
  
  # Start SolidQueue worker in production
  pids << spawn(
    { "RAILS_ENV" => "production" },
    "bin/jobs"
  )
  
  # In production mode, let Rails server daemonize and jobs run in background
  puts "âœ… Production processes started"
  puts "   Rails server: port 4567 (daemonized)"
  puts "   SolidQueue worker: background process"
  puts "   Use 'bin/stop' to stop all processes"
end